/*
Resource to IOR.
*/
resource "null_resource" "smallfile-setup" {
  depends_on = [
    oci_core_instance.client_node,
    oci_core_instance.gluster_server
  ]
  count = 0
# 1
  triggers = {
    instance_ids = join(",", oci_core_instance.client_node.*.id)
  }

  provisioner "file" {
    source      = "../scripts/"
    destination = "/tmp/"
    connection {
      agent               = false
      timeout             = "30m"
      host                = element(oci_core_instance.client_node.*.private_ip, count.index)
      user                = var.ssh_user
      private_key         = var.ssh_private_key
      bastion_host        = oci_core_instance.bastion[0].public_ip
      bastion_port        = "22"
      bastion_user        = var.ssh_user
      bastion_private_key = var.ssh_private_key
    }
  }

  provisioner "remote-exec" {
    connection {
      agent               = false
      timeout             = "30m"
      host                = element(oci_core_instance.client_node.*.private_ip, count.index)
      user                = var.ssh_user
      private_key         = var.ssh_private_key
      bastion_host        = oci_core_instance.bastion[0].public_ip
      bastion_port        = "22"
      bastion_user        = var.ssh_user
      bastion_private_key = var.ssh_private_key
    }
    inline = [
      "set -x",
      "sudo -s bash -c 'set -x && chmod 777 /tmp/*.sh'",
      "sudo -s bash -c 'set -x && /tmp/smallfile_benchmark_install.sh ${var.beegfs["mount_point"]}'",
    ]
  }
}



